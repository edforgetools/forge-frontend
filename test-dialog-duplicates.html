<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dialog Duplicate Handler Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .test-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .test-button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
        font-weight: bold;
      }
      .warning {
        color: #ffc107;
        font-weight: bold;
      }
      .error {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Dialog Duplicate Handler Test</h1>
    <p>
      This test verifies that opening/closing dialogs multiple times never
      duplicates handlers.
    </p>

    <div class="test-section">
      <h2>Test Instructions</h2>
      <ol>
        <li>Click "Open Dialog" to open a test dialog</li>
        <li>Press <kbd>Escape</kbd> to close it</li>
        <li>Repeat steps 1-2 multiple times</li>
        <li>
          Check the console logs below - you should see only one handler
          registration per dialog open
        </li>
      </ol>
    </div>

    <div class="test-section">
      <h2>Test Controls</h2>
      <button class="test-button" onclick="openTestDialog()">
        Open Dialog
      </button>
      <button class="test-button" onclick="clearLogs()">Clear Logs</button>
      <button class="test-button" onclick="checkHandlerCount()">
        Check Handler Count
      </button>
    </div>

    <div class="test-section">
      <h2>Console Logs</h2>
      <div id="logs" class="log"></div>
    </div>

    <div class="test-section">
      <h2>Test Results</h2>
      <div id="results"></div>
    </div>

    <!-- Test Dialog -->
    <div
      id="testDialog"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      "
    >
      <div
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 5px;
          min-width: 300px;
        "
      >
        <h3>Test Dialog</h3>
        <p>This is a test dialog to verify handler duplication prevention.</p>
        <p>Press <kbd>Escape</kbd> to close or click the button below.</p>
        <button class="test-button" onclick="closeTestDialog()">
          Close Dialog
        </button>
      </div>
    </div>

    <script>
      // Mock the key registry for testing
      class MockKeyRegistry {
        constructor() {
          this.bindings = new Map();
          this.listeners = new Map();
          this.isInitialized = false;
          this.documentListener = null;
          this.log("üîß Mock Key Registry initialized");
        }

        log(message) {
          const timestamp = new Date().toLocaleTimeString();
          const logElement = document.getElementById("logs");
          logElement.textContent += `[${timestamp}] ${message}\n`;
          logElement.scrollTop = logElement.scrollHeight;
          console.log(message);
        }

        register(binding) {
          this.log(
            `üîë Registering key binding: ${binding.id} (${binding.key})`
          );

          // Ensure clean state before registering (important for HMR)
          this.ensureCleanState();

          if (this.bindings.has(binding.id)) {
            this.log(
              `‚ö†Ô∏è Key binding with id "${binding.id}" already exists. Overwriting.`
            );
            this.unregister(binding.id);
          }

          // Set defaults
          const normalizedBinding = {
            enabled: true,
            preventDefault: true,
            stopPropagation: false,
            ...binding,
          };

          this.bindings.set(binding.id, normalizedBinding);
          this.initialize();
          this.log(`‚úÖ Key binding registered: ${binding.id}`);
        }

        unregister(id) {
          const existed = this.bindings.delete(id);
          if (existed) {
            this.log(`üóëÔ∏è Unregistered key binding: ${id}`);
          }
          return existed;
        }

        initialize() {
          if (this.isInitialized) return;

          this.documentListener = (event) => {
            // Check each binding to see if it matches
            for (const binding of this.bindings.values()) {
              if (!binding.enabled) continue;
              if (this.matchesBinding(event, binding)) {
                if (binding.preventDefault) {
                  event.preventDefault();
                }
                if (binding.stopPropagation) {
                  event.stopPropagation();
                }
                this.log(
                  `üéØ Key binding triggered: ${binding.id} (${binding.key})`
                );
                binding.handler(event);
              }
            }
          };

          document.addEventListener("keydown", this.documentListener);
          this.isInitialized = true;
          this.log("üéß Global key listener initialized");
        }

        matchesBinding(event, binding) {
          const key = binding.key.toLowerCase();
          if (key === "escape") {
            return event.key === "Escape";
          }
          return false; // Simplified for this test
        }

        ensureCleanState() {
          if (this.isInitialized || this.bindings.size > 0) {
            this.log("üßπ Ensuring clean state before rebind");
            this.cleanup();
          }
        }

        cleanup() {
          this.log("üßπ Cleaning up all listeners and bindings");

          if (this.documentListener) {
            document.removeEventListener("keydown", this.documentListener);
            this.documentListener = null;
          }

          this.bindings.clear();
          this.listeners.clear();
          this.isInitialized = false;

          this.log("‚úÖ Cleanup completed");
        }

        getDebugInfo() {
          return {
            bindings: Array.from(this.bindings.values()),
            isInitialized: this.isInitialized,
          };
        }
      }

      // Create mock registry instance
      const mockKeyRegistry = new MockKeyRegistry();

      // Mock the registerKey function
      function registerKey(binding) {
        mockKeyRegistry.register(binding);
      }

      function unregisterKey(id) {
        return mockKeyRegistry.unregister(id);
      }

      // Dialog state
      let dialogOpenCount = 0;
      let currentBindingId = null;

      function openTestDialog() {
        dialogOpenCount++;
        const dialog = document.getElementById("testDialog");
        dialog.style.display = "block";

        // Register escape key binding for this dialog instance
        const bindingId = `dialog-escape-${dialogOpenCount}`;
        currentBindingId = bindingId;

        registerKey({
          id: bindingId,
          key: "escape",
          handler: (event) => {
            mockKeyRegistry.log(
              `üö™ Escape pressed - closing dialog ${dialogOpenCount}`
            );
            closeTestDialog();
          },
          description: `Close dialog ${dialogOpenCount}`,
        });

        mockKeyRegistry.log(
          `üìÇ Dialog ${dialogOpenCount} opened with binding: ${bindingId}`
        );
      }

      function closeTestDialog() {
        const dialog = document.getElementById("testDialog");
        dialog.style.display = "none";

        if (currentBindingId) {
          unregisterKey(currentBindingId);
          mockKeyRegistry.log(
            `üìÇ Dialog closed, unregistered binding: ${currentBindingId}`
          );
          currentBindingId = null;
        }
      }

      function clearLogs() {
        document.getElementById("logs").textContent = "";
        document.getElementById("results").innerHTML = "";
      }

      function checkHandlerCount() {
        const debugInfo = mockKeyRegistry.getDebugInfo();
        const resultsDiv = document.getElementById("results");

        let resultHtml = "<h3>Handler Count Check</h3>";
        resultHtml += `<p><strong>Active bindings:</strong> ${debugInfo.bindings.length}</p>`;
        resultHtml += `<p><strong>Registry initialized:</strong> ${
          debugInfo.isInitialized ? "Yes" : "No"
        }</p>`;

        if (debugInfo.bindings.length === 0) {
          resultHtml +=
            '<p class="success">‚úÖ No duplicate handlers detected!</p>';
        } else if (debugInfo.bindings.length === 1) {
          resultHtml +=
            '<p class="warning">‚ö†Ô∏è One handler still active (expected if dialog is open)</p>';
        } else {
          resultHtml +=
            '<p class="error">‚ùå Multiple handlers detected - potential duplication!</p>';
        }

        if (debugInfo.bindings.length > 0) {
          resultHtml += "<h4>Active Bindings:</h4><ul>";
          debugInfo.bindings.forEach((binding) => {
            resultHtml += `<li>${binding.id} (${binding.key})</li>`;
          });
          resultHtml += "</ul>";
        }

        resultsDiv.innerHTML = resultHtml;
      }

      // Initial log
      mockKeyRegistry.log("üöÄ Test page loaded - ready for testing");
    </script>
  </body>
</html>
